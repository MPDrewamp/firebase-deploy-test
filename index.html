<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chotu NexS by ARYA</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* Previous CSS remains the same, adding new styles for Tray Scans */
    
    /* Tray Scan specific styles */
    .tray-scan-container {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    #trayScanInput {
      font-size: 18px;
      padding: 15px;
      text-align: center;
    }
    
    .tray-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
    }
    
    .tray-valid {
      background-color: #d4edda;
      color: #155724;
    }
    
    .tray-invalid {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    /* Add to existing modal CSS */
    .modal-content {
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <button class="toggle-sidebar">‚ò∞</button>
    <h1>Chotu NexS by ARYA</h1>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">NexS</div>
    <button class="active" onclick="showTab('packingTab', this)"><i>üì¶</i> Packing Scans</button>
    <button onclick="showTab('dispatchTab', this)"><i>üöö</i> Dispatch Scans</button>
    <button onclick="showTab('trayTab', this)"><i>üß∫</i> Tray Scans</button>
    <button onclick="showTab('excelTab', this)"><i>üìÅ</i> Excel Upload</button>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Stats panel - top right -->
    <div class="stats-card" id="activeStatsCard">
      <h3 id="statsTitle">Station Activity</h3>
      <div class="stats-number" id="statsCount">0</div>
      <div class="stats-label">Scans in the last hour</div>
      <div class="stats-label" id="statsStationName">No station selected</div>
    </div>

    <div class="center-container">
      <!-- Packing Scan -->
      <div id="packingTab" class="tab active">
        <div class="card">
          <h2>Packing Scan</h2>
          <form id="packingForm">
            <label>Scan ID:
              <input type="text" id="packingShippingID" required placeholder="Enter SNXS + 16 digits" />
              <small>Format: SNXS followed by 16 digits (e.g., SNXS1250000012421880)</small>
            </label>
            <label>Station ID:
              <select id="packingStationID" required>
                <option value="" disabled selected>Select packing station</option>
                <script>
                  for (let i = 1; i <= 30; i++) {
                    const stationId = i < 10 ? `PS0${i}` : `PS${i}`;
                    document.write(`<option value="${stationId}">${stationId}</option>`);
                  }
                </script>
              </select>
            </label>
            <label>NexS ID:
              <input type="text" id="packingNexSID" required placeholder="Enter NexS ID" />
            </label>
          </form>
        </div>
      </div>

      <!-- Dispatch Scan -->
      <div id="dispatchTab" class="tab">
        <div class="card">
          <h2>Dispatch Scan</h2>
          <form id="dispatchForm">
            <label>Scan ID:
              <input type="text" id="dispatchShippingID" required placeholder="Enter shipping ID" />
              <small>Cannot use Packing format (SNXS + 16 digits)</small>
            </label>
            <label>Station ID:
              <select id="dispatchStationID" required>
                <option value="" disabled selected>Select dispatch station</option>
                <script>
                  for (let i = 1; i <= 25; i++) {
                    const stationId = i < 10 ? `DS0${i}` : `DS${i}`;
                    document.write(`<option value="${stationId}">${stationId}</option>`);
                  }
                </script>
              </select>
            </label>
            <label>NexS ID:
              <input type="text" id="dispatchNexSID" required placeholder="Enter NexS ID" />
            </label>
          </form>
        </div>
      </div>

      <!-- Tray Scan -->
      <div id="trayTab" class="tab">
        <div class="card">
          <h2>Tray Scan Validation</h2>
          <div class="tray-scan-container">
            <label>Tray ID:
              <input type="text" id="trayScanInput" placeholder="Scan Tray ID" autofocus />
              <small>Scan tray to validate against shipping metadata</small>
            </label>
            <div id="trayStatus" class="tray-status" style="display: none;">
              City: <span id="trayCity"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Excel Upload -->
      <div id="excelTab" class="tab">
        <div class="card">
          <h2>Upload Excel File</h2>
          <form id="excelForm">
            <label>Upload Excel:
              <input type="file" id="excelFile" accept=".xlsx, .xls" />
            </label>
            <p><small>Expected columns: <strong>ShippingID</strong> and <strong>City</strong></small></p>
            <div class="button-container">
              <button type="submit">Upload File</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for city information -->
  <div id="cityModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>Shipping Information</h3>
      <div class="city-name" id="cityDisplay"></div>
    </div>
  </div>

  <!-- Modal for duplicate scan warning -->
  <div id="duplicateModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeDuplicateModal()">&times;</span>
      <h3>Duplicate Scan Detected</h3>
      <p>This item was already scanned (even at the same station).</p>
      <p id="duplicateDetails"></p>
      <div class="modal-buttons">
        <button class="modal-button" onclick="closeDuplicateModal()">OK</button>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast">Scan successful</div>

  <!-- Scripts -->
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyByKgnrhB_4WvwDkkfVU-ZoVwG43X8FPg4",
      authDomain: "packing-dispatch-rewamp.firebaseapp.com",
      databaseURL: "https://packing-dispatch-rewamp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "packing-dispatch-rewamp",
      storageBucket: "packing-dispatch-rewamp.appspot.com",
      messagingSenderId: "369109746944",
      appId: "1:369109746944:web:fc5a8db4c016997c581fe5"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Track all scans for duplicate detection
    const scanHistory = {
      packing: {},
      dispatch: {}
    };

    // ===== SIDEBAR FUNCTIONALITY =====
    const toggleSidebar = document.querySelector(".toggle-sidebar");
    const sidebar = document.querySelector(".sidebar");
    const content = document.querySelector(".content");
    let sidebarVisible = true;

    toggleSidebar.addEventListener("click", function() {
      sidebarVisible = !sidebarVisible;
      if (sidebarVisible) {
        sidebar.classList.remove("sidebar-collapsed");
        content.classList.remove("content-expanded");
      } else {
        sidebar.classList.add("sidebar-collapsed");
        content.classList.add("content-expanded");
      }
    });

    // ===== TAB SWITCHING =====
    function showTab(id, button) {
      // Hide all tabs and remove active class from all buttons
      document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".sidebar button").forEach(btn => btn.classList.remove("active"));
      
      // Show the selected tab and mark the button as active
      document.getElementById(id).classList.add("active");
      button.classList.add("active");
      
      // Update stats title based on active tab
      const statsTitle = document.getElementById("statsTitle");
      if (id === "packingTab") {
        statsTitle.textContent = "Packing Activity";
        updateStationCount("packing");
      } else if (id === "dispatchTab") {
        statsTitle.textContent = "Dispatch Activity";
        updateStationCount("dispatch");
      } else if (id === "trayTab") {
        statsTitle.textContent = "Tray Validation";
        document.getElementById("trayScanInput").focus();
      } else {
        statsTitle.textContent = "Station Activity";
      }
    }

    // ===== TOAST NOTIFICATION FUNCTIONS =====
    function showToast(message, type = "success") {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "toast " + type + " show";
      
      // Hide toast after 3 seconds
      setTimeout(() => {
        toast.className = toast.className.replace("show", "");
      }, 3000);
    }

    // ===== CITY MODAL FUNCTIONS =====
    const cityModal = document.getElementById("cityModal");
    const closeModalButtons = document.querySelectorAll(".close-modal");
    const cityDisplay = document.getElementById("cityDisplay");

    function showCityModal(city) {
      cityDisplay.textContent = city;
      cityModal.style.display = "block";
      
      // Auto-dismiss after 3 seconds
      setTimeout(() => {
        cityModal.style.display = "none";
      }, 3000);
    }

    closeModalButtons.forEach(button => {
      button.onclick = function() {
        button.closest(".modal").style.display = "none";
      }
    });

    window.onclick = function(event) {
      if (event.target == cityModal) {
        cityModal.style.display = "none";
      }
      if (event.target == duplicateModal) {
        duplicateModal.style.display = "none";
      }
    }

    // ===== DUPLICATE SCAN MODAL FUNCTIONS =====
    const duplicateModal = document.getElementById("duplicateModal");
    const duplicateDetails = document.getElementById("duplicateDetails");

    function showDuplicateModal(scanId, existingData) {
      let details = `Scan ID: ${scanId}`;
      if (existingData) {
        details += `\nPreviously scanned at: ${existingData["Station ID"] || 'Unknown Station'}`;
        details += `\nOn: ${existingData.DATE} ${existingData.TIME}`;
      }
      duplicateDetails.textContent = details;
      duplicateModal.style.display = "block";
    }

    function closeDuplicateModal() {
      duplicateModal.style.display = "none";
    }

    // ===== SCAN HISTORY MANAGEMENT =====
    function logScan(scanType, scanId, data) {
      // Store in memory for duplicate detection
      scanHistory[scanType][scanId] = data;
      
      // Also store in Firebase (for persistence across page refreshes)
      db.ref(`scan_history/${scanType}/${scanId}`).set(data);
    }

    function checkDuplicate(scanType, scanId) {
      // Check both in-memory and Firebase for duplicates
      return Promise.resolve(scanHistory[scanType][scanId] || null)
        .then((existingData) => {
          if (existingData) return existingData;
          return db.ref(`scan_history/${scanType}/${scanId}`).once('value')
            .then(snapshot => snapshot.val());
        });
    }

    // ===== TRAY SCAN FUNCTIONALITY =====
    document.getElementById("trayScanInput").addEventListener("input", function() {
      const trayId = this.value.trim().toUpperCase();
      if (trayId.length < 3) return; // Minimum length check
      
      // Check shipping metadata
      db.ref(`shipping_metadata/${trayId}`).once("value")
        .then(snapshot => {
          const trayStatus = document.getElementById("trayStatus");
          const trayCity = document.getElementById("trayCity");
          
          if (snapshot.exists() && snapshot.val().City) {
            const city = snapshot.val().City.toUpperCase();
            trayCity.textContent = city;
            trayStatus.className = "tray-status tray-valid";
            trayStatus.style.display = "block";
            showToast(`Valid tray: ${city}`, "success");
          } else {
            trayCity.textContent = "NOT FOUND";
            trayStatus.className = "tray-status tray-invalid";
            trayStatus.style.display = "block";
            showToast("Tray ID not in database", "error");
          }
          
          // Clear input for next scan
          setTimeout(() => {
            this.value = "";
            trayStatus.style.display = "none";
          }, 2000);
        })
        .catch(error => {
          console.error("Tray scan error:", error);
          showToast("Error validating tray", "error");
        });
    });

    // ===== PACKING SCAN FUNCTIONALITY =====
    document.getElementById("packingShippingID").addEventListener("input", function() {
      const scanId = this.value.trim().toUpperCase();
      this.value = scanId;
      
      if (isValidPackingScanId(scanId)) {
        this.classList.add("valid");
        this.classList.remove("invalid");
        
        const stationID = document.getElementById("packingStationID").value;
        const nexSID = document.getElementById("packingNexSID").value.trim();
        
        if (stationID && nexSID) {
          processPacking(scanId, stationID, nexSID);
        }
      } else {
        if (scanId.length > 0) {
          this.classList.add("invalid");
          this.classList.remove("valid");
        } else {
          this.classList.remove("valid");
          this.classList.remove("invalid");
        }
      }
    });

    // Process Packing Scan (updated duplicate handling)
    function processPacking(scanId, stationId, nexSId) {
      checkDuplicate("packing", scanId)
        .then((existingData) => {
          const now = new Date();
          const date = now.toISOString().split('T')[0];
          const time = now.toLocaleTimeString("en-GB");
          
          const scanData = {
            "Station ID": stationId,
            "NexS ID": nexSId,
            "DATE": date,
            "TIME": time,
          };
          
          // Always log the scan (even if duplicate)
          logScan("packing", scanId, scanData);
          
          if (existingData) {
            // Show duplicate warning (even if same station)
            showDuplicateModal(scanId, existingData);
            document.getElementById("packingShippingID").value = "";
            return Promise.reject("Duplicate scan detected");
          }
          
          // Save to packing_scans if not duplicate
          return db.ref(`packing_scans/${scanId}`).set(scanData)
            .then(() => {
              return firebase.database().ref("shipping_metadata/" + scanId).once("value");
            });
        })
        .then((metaSnapshot) => {
          const cityData = metaSnapshot.val();
          
          showToast("Packing scan successful");
          
          if (cityData && cityData.City) {
            showCityModal(cityData.City.toUpperCase());
          }
          
          document.getElementById("packingShippingID").value = "";
          document.getElementById("packingShippingID").classList.remove("valid");
          updateStationCount("packing");
        })
        .catch((error) => {
          if (error !== "Duplicate scan detected") {
            console.error("Packing Scan Error:", error);
            showToast("Error processing scan", "error");
          }
        });
    }

    // ===== DISPATCH SCAN FUNCTIONALITY =====
    document.getElementById("dispatchShippingID").addEventListener("input", function() {
      const scanId = this.value.trim().toUpperCase();
      this.value = scanId;
      
      if (isPackingFormat(scanId)) {
        this.classList.add("invalid");
        this.classList.remove("valid");
        showToast("Invalid format for dispatch", "error");
        return;
      }
      
      if (scanId.length > 0) {
        this.classList.add("valid");
        this.classList.remove("invalid");
        
        const stationID = document.getElementById("dispatchStationID").value;
        const nexSID = document.getElementById("dispatchNexSID").value.trim();
        
        if (stationID && nexSID) {
          processDispatch(scanId, stationID, nexSID);
        }
      } else {
        this.classList.remove("valid");
        this.classList.remove("invalid");
      }
    });

    // Process Dispatch Scan (updated duplicate handling)
    function processDispatch(scanId, stationId, nexSId) {
      checkDuplicate("dispatch", scanId)
        .then((existingData) => {
          const now = new Date();
          const date = now.toISOString().split('T')[0];
          const time = now.toLocaleTimeString("en-GB");
          
          const scanData = {
            "Station ID": stationId,
            "NexS ID": nexSId,
            "DATE": date,
            "TIME": time,
          };
          
          // Always log the scan (even if duplicate)
          logScan("dispatch", scanId, scanData);
          
          if (existingData) {
            // Show duplicate warning (even if same station)
            showDuplicateModal(scanId, existingData);
            document.getElementById("dispatchShippingID").value = "";
            return Promise.reject("Duplicate scan detected");
          }
          
          // Save to dispatch_scans if not duplicate
          return db.ref(`dispatch_scans/${scanId}`).set(scanData)
            .then(() => {
              return firebase.database().ref("shipping_metadata/" + scanId).once("value");
            });
        })
        .then((metaSnapshot) => {
          const cityData = metaSnapshot.val();
          
          showToast("Dispatch scan successful");
          
          if (cityData && cityData.City) {
            showCityModal(cityData.City.toUpperCase());
          }
          
          document.getElementById("dispatchShippingID").value = "";
          document.getElementById("dispatchShippingID").classList.remove("valid");
          updateStationCount("dispatch");
        })
        .catch((error) => {
          if (error !== "Duplicate scan detected") {
            console.error("Dispatch Scan Error:", error);
            showToast("Error processing scan", "error");
          }
        });
    }

    // ===== EXCEL UPLOAD FUNCTIONALITY =====
    document.getElementById("excelForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const fileInput = document.getElementById("excelFile");
      const file = fileInput.files[0];
      
      if (!file) {
        showToast("Please select an Excel file first!", "error");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        
        let count = 0;
        const updates = {};
        
        rows.forEach((row) => {
          if (row.ShippingID && row.City) {
            updates[`shipping_metadata/${row.ShippingID}`] = { City: row.City };
            count++;
          }
        });

        db.ref().update(updates)
          .then(() => {
            showToast(`Excel uploaded successfully! ${count} shipping records imported.`);
            fileInput.value = "";
          })
          .catch(error => {
            console.error("Upload error:", error);
            showToast("Error uploading data", "error");
          });
      };
      reader.readAsArrayBuffer(file);
    });

    // ===== HELPER FUNCTIONS =====
    function isValidPackingScanId(scanId) {
      return /^SNXS\d{16}$/.test(scanId);
    }

    function isPackingFormat(scanId) {
      return /^SNXS\d{16}$/.test(scanId);
    }

    function updateStationCount(scanType) {
      let stationId;
      let stationNameElement = document.getElementById("statsStationName");
      let countElement = document.getElementById("statsCount");
      
      if (scanType === "packing") {
        stationId = document.getElementById("packingStationID").value;
      } else {
        stationId = document.getElementById("dispatchStationID").value;
      }
      
      if (!stationId) {
        countElement.textContent = "0";
        stationNameElement.textContent = "No station selected";
        return;
      }
      
      stationNameElement.textContent = `Station: ${stationId}`;
      
      const oneHourAgo = new Date();
      oneHourAgo.setHours(oneHourAgo.getHours() - 1);
      
      const dbRef = scanType === "packing" ? "packing_scans" : "dispatch_scans";
      
      db.ref(dbRef).orderByChild("Station ID").equalTo(stationId).once("value")
        .then((snapshot) => {
          let count = 0;
          snapshot.forEach((childSnapshot) => {
            const scan = childSnapshot.val();
            const scanDateTime = new Date(`${scan.DATE} ${scan.TIME}`);
            if (scanDateTime >= oneHourAgo) count++;
          });
          countElement.textContent = count;
        })
        .catch((error) => {
          console.error("Error fetching scan counts:", error);
          countElement.textContent = "Error";
        });
    }

    // Initialize
    function setupCountRefresh() {
      updateStationCount("packing");
      updateStationCount("dispatch");
      
      setInterval(() => {
        const activeTab = document.querySelector(".tab.active").id;
        if (activeTab === "packingTab") updateStationCount("packing");
        else if (activeTab === "dispatchTab") updateStationCount("dispatch");
      }, 45000);
    }

    // Load existing scan history
    function loadScanHistory() {
      db.ref("scan_history").once("value")
        .then(snapshot => {
          const data = snapshot.val() || {};
          scanHistory.packing = data.packing || {};
          scanHistory.dispatch = data.dispatch || {};
        });
    }

    // Initialize on page load
    window.onload = function() {
      setupCountRefresh();
      loadScanHistory();
      document.getElementById("packingStationID").addEventListener("change", () => updateStationCount("packing"));
      document.getElementById("dispatchStationID").addEventListener("change", () => updateStationCount("dispatch"));
    };
  </script>
</body>
</html>
