<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chotu NexS by ARYA</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Header */
    .header {
      background: #2c3e50;
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
    }

    .header .toggle-sidebar {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      margin-right: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #2c3e50;
      color: white;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
      height: 100%;
      position: fixed;
      top: 60px;
      left: 0;
      transition: transform 0.3s ease;
      z-index: 90;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    .sidebar-collapsed {
      transform: translateX(-250px);
    }

    .sidebar .logo {
      padding: 0 20px 20px;
      font-size: 24px;
      font-weight: bold;
      color: #3498db;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }

    .sidebar button {
      background: none;
      color: white;
      border: none;
      padding: 15px 20px;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
    }

    .sidebar button i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    .sidebar button:hover,
    .sidebar button.active {
      background-color: #34495e;
      border-left: 4px solid #3498db;
    }

    /* Content */
    .content {
      flex: 1;
      padding: 40px;
      margin-top: 60px;
      margin-left: 250px;
      transition: margin-left 0.3s ease;
      overflow-y: auto;
      display: flex;
    }

    .content-expanded {
      margin-left: 0;
    }

    /* Content left (forms) */
    .content-left {
      flex: 3;
    }

    /* Content right (stats) */
    .content-right {
      flex: 1;
      margin-left: 20px;
    }

    .tab {
      display: none;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .tab.active {
      display: flex;
      flex-direction: column;
    }

    .card {
      background: white;
      max-width: 500px;
      margin: 20px auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stats-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    .stats-card h3 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .stats-number {
      font-size: 32px;
      font-weight: bold;
      color: #3498db;
      text-align: center;
      margin: 20px 0;
    }

    .stats-label {
      text-align: center;
      color: #7f8c8d;
      font-size: 14px;
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #2c3e50;
      text-align: center;
      font-weight: 600;
    }

    label {
      display: block;
      margin-bottom: 15px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      border: 1px solid #dce4ec;
      border-radius: 6px;
      margin-top: 8px;
      background-color: #f8f9fa;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="text"]:focus,
    input[type="file"]:focus,
    select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    input.valid {
      border-color: #27ae60;
      background-color: #f0fff0;
    }

    input.invalid {
      border-color: #e74c3c;
      background-color: #fff0f0;
    }

    .button-container {
      text-align: center;
      margin-top: 25px;
    }

    button[type="submit"] {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    button[type="submit"]:hover {
      background-color: #2980b9;
    }

    button[type="submit"]:active {
      transform: translateY(2px);
    }

    small {
      color: #7f8c8d;
      font-size: 13px;
    }

    /* Modal/Popup */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px 30px;
      border-radius: 8px;
      width: 350px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: slideIn 0.3s;
      text-align: center;
    }

    @keyframes slideIn {
      from {transform: translateY(-50px); opacity: 0;}
      to {transform: translateY(0); opacity: 1;}
    }

    .close-modal {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      margin-top: -10px;
    }

    .close-modal:hover,
    .close-modal:focus {
      color: black;
      text-decoration: none;
    }

    .city-name {
      font-size: 24px;
      font-weight: bold;
      margin: 20px 0;
      color: #2c3e50;
    }

    .modal-buttons {
      margin-top: 20px;
    }

    .modal-button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 15px;
      transition: background-color 0.3s;
    }

    .modal-button:hover {
      background-color: #2980b9;
    }

    /* Toast notification */
    .toast {
      visibility: hidden;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 16px 25px;
      border-radius: 8px;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .toast.success {
      background-color: #27ae60;
    }

    .toast.error {
      background-color: #e74c3c;
    }

    .toast.warning {
      background-color: #f39c12;
    }

    .toast.show {
      visibility: visible;
      animation: fadeInUp 0.5s, fadeOut 0.5s 2.5s;
    }

    @keyframes fadeInUp {
      from {bottom: 0; opacity: 0;}
      to {bottom: 30px; opacity: 1;}
    }

    @keyframes fadeOut {
      from {opacity: 1;}
      to {opacity: 0;}
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <button class="toggle-sidebar">‚ò∞</button>
    <h1>Chotu NexS by ARYA</h1>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">NexS</div>
    <button class="active" onclick="showTab('packingTab', this)"><i>üì¶</i> Packing Scans</button>
    <button onclick="showTab('dispatchTab', this)"><i>üöö</i> Dispatch Scans</button>
    <button onclick="showTab('excelTab', this)"><i>üìÅ</i> Excel Upload</button>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Packing Scan -->
    <div id="packingTab" class="tab active">
      <div class="content-left">
        <div class="card">
          <h2>Packing Scan</h2>
          <form id="packingForm">
            <label>Scan ID:
              <input type="text" id="packingShippingID" required placeholder="Enter SNXS + 16 digits" />
              <small>Format: SNXS followed by 16 digits (e.g., SNXS1250000012421880)</small>
            </label>
            <label>Station ID:
              <select id="packingStationID" required>
                <option value="" disabled selected>Select packing station</option>
                <script>
                  for (let i = 1; i <= 30; i++) {
                    const stationId = i < 10 ? `PS0${i}` : `PS${i}`;
                    document.write(`<option value="${stationId}">${stationId}</option>`);
                  }
                </script>
              </select>
            </label>
            <label>NexS ID:
              <input type="text" id="packingNexSID" required placeholder="Enter NexS ID" />
            </label>
            <!-- Submit button removed as per requirements -->
          </form>
        </div>
      </div>
      
      <!-- Stats panel -->
      <div class="content-right">
        <div class="stats-card">
          <h3>Packing Station Activity</h3>
          <div class="stats-number" id="packingStationCount">0</div>
          <div class="stats-label">Scans in the last hour</div>
          <div class="stats-label" id="packingStationName">No station selected</div>
        </div>
      </div>
    </div>

    <!-- Dispatch Scan -->
    <div id="dispatchTab" class="tab">
      <div class="content-left">
        <div class="card">
          <h2>Dispatch Scan</h2>
          <form id="dispatchForm">
            <label>Scan ID:
              <input type="text" id="dispatchShippingID" required placeholder="Enter shipping ID" />
              <small>Cannot use Packing format (SNXS + 16 digits)</small>
            </label>
            <label>Station ID:
              <select id="dispatchStationID" required>
                <option value="" disabled selected>Select dispatch station</option>
                <script>
                  for (let i = 1; i <= 25; i++) {
                    const stationId = i < 10 ? `DS0${i}` : `DS${i}`;
                    document.write(`<option value="${stationId}">${stationId}</option>`);
                  }
                </script>
              </select>
            </label>
            <label>NexS ID:
              <input type="text" id="dispatchNexSID" required placeholder="Enter NexS ID" />
            </label>
            <!-- Submit button removed as per requirements -->
          </form>
        </div>
      </div>
      
      <!-- Stats panel -->
      <div class="content-right">
        <div class="stats-card">
          <h3>Dispatch Station Activity</h3>
          <div class="stats-number" id="dispatchStationCount">0</div>
          <div class="stats-label">Scans in the last hour</div>
          <div class="stats-label" id="dispatchStationName">No station selected</div>
        </div>
      </div>
    </div>

    <!-- Excel Upload -->
    <div id="excelTab" class="tab">
      <div class="content-left">
        <div class="card">
          <h2>Upload Excel File</h2>
          <form id="excelForm">
            <label>Upload Excel:
              <input type="file" id="excelFile" accept=".xlsx, .xls" />
            </label>
            <p><small>Expected columns: <strong>ShippingID</strong> and <strong>City</strong></small></p>
            <div class="button-container">
              <button type="submit">Upload File</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for city information -->
  <div id="cityModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>Shipping Information</h3>
      <div class="city-name" id="cityDisplay"></div>
      <!-- OK button removed as requested -->
    </div>
  </div>

  <!-- Modal for duplicate scan warning -->
  <div id="duplicateModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeDuplicateModal()">&times;</span>
      <h3>Duplicate Scan Detected</h3>
      <p>This item was already scanned at a different station.</p>
      <p id="duplicateDetails"></p>
      <div class="modal-buttons">
        <button class="modal-button" onclick="closeDuplicateModal()">OK</button>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast">Scan successful</div>

  <!-- Scripts -->
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyByKgnrhB_4WvwDkkfVU-ZoVwG43X8FPg4",
      authDomain: "packing-dispatch-rewamp.firebaseapp.com",
      databaseURL: "https://packing-dispatch-rewamp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "packing-dispatch-rewamp",
      storageBucket: "packing-dispatch-rewamp.appspot.com",
      messagingSenderId: "369109746944",
      appId: "1:369109746944:web:fc5a8db4c016997c581fe5"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // ===== SIDEBAR FUNCTIONALITY =====
    const toggleSidebar = document.querySelector(".toggle-sidebar");
    const sidebar = document.querySelector(".sidebar");
    const content = document.querySelector(".content");
    let sidebarVisible = true;

    toggleSidebar.addEventListener("click", function() {
      sidebarVisible = !sidebarVisible;
      if (sidebarVisible) {
        sidebar.classList.remove("sidebar-collapsed");
        content.classList.remove("content-expanded");
      } else {
        sidebar.classList.add("sidebar-collapsed");
        content.classList.add("content-expanded");
      }
    });

    // ===== TAB SWITCHING =====
    function showTab(id, button) {
      // Hide all tabs and remove active class from all buttons
      document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".sidebar button").forEach(btn => btn.classList.remove("active"));
      
      // Show the selected tab and mark the button as active
      document.getElementById(id).classList.add("active");
      button.classList.add("active");
      
      // Update station counts when switching tabs
      if (id === "packingTab") {
        updateStationCount("packing");
      } else if (id === "dispatchTab") {
        updateStationCount("dispatch");
      }
    }

    // ===== TOAST NOTIFICATION FUNCTIONS =====
    function showToast(message, type = "success") {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "toast " + type + " show";
      
      // Hide toast after 3 seconds
      setTimeout(() => {
        toast.className = toast.className.replace("show", "");
      }, 3000);
    }

    // ===== CITY MODAL FUNCTIONS =====
    const cityModal = document.getElementById("cityModal");
    const closeModalButtons = document.querySelectorAll(".close-modal");
    const cityDisplay = document.getElementById("cityDisplay");

    function showCityModal(city) {
      cityDisplay.textContent = city;
      cityModal.style.display = "block";
      
      // Auto-dismiss after 3 seconds
      setTimeout(() => {
        cityModal.style.display = "none";
      }, 3000);
    }

    closeModalButtons.forEach(button => {
      button.onclick = function() {
        button.closest(".modal").style.display = "none";
      }
    });

    window.onclick = function(event) {
      if (event.target == cityModal) {
        cityModal.style.display = "none";
      }
      if (event.target == duplicateModal) {
        duplicateModal.style.display = "none";
      }
    }

    // ===== DUPLICATE SCAN MODAL FUNCTIONS =====
    const duplicateModal = document.getElementById("duplicateModal");
    const duplicateDetails = document.getElementById("duplicateDetails");

    function showDuplicateModal(scanId, previousStation) {
      duplicateDetails.textContent = `Scan ID: ${scanId} was already processed at station: ${previousStation}`;
      duplicateModal.style.display = "block";
    }

    function closeDuplicateModal() {
      duplicateModal.style.display = "none";
    }

    // ===== VALIDATION FUNCTIONS =====
    
    // Validate Packing Scan ID format (SNXS + 16 digits)
    function isValidPackingScanId(scanId) {
      const packingScanRegex = /^SNXS\d{16}$/;
      return packingScanRegex.test(scanId);
    }

    // Check if a Scan ID is in packing format (to reject from dispatch)
    function isPackingFormat(scanId) {
      const packingScanRegex = /^SNXS\d{16}$/;
      return packingScanRegex.test(scanId);
    }

    // ===== SCAN COUNT FUNCTIONS =====
    
    // Update station scan count 
    function updateStationCount(scanType) {
      let stationId;
      let stationNameElement;
      let countElement;
      
      if (scanType === "packing") {
        stationId = document.getElementById("packingStationID").value;
        stationNameElement = document.getElementById("packingStationName");
        countElement = document.getElementById("packingStationCount");
      } else {
        stationId = document.getElementById("dispatchStationID").value;
        stationNameElement = document.getElementById("dispatchStationName");
        countElement = document.getElementById("dispatchStationCount");
      }
      
      // If no station selected, don't try to count
      if (!stationId) {
        countElement.textContent = "0";
        stationNameElement.textContent = "No station selected";
        return;
      }
      
      // Update station name display
      stationNameElement.textContent = `Station: ${stationId}`;
      
      // Calculate time one hour ago
      const oneHourAgo = new Date();
      oneHourAgo.setHours(oneHourAgo.getHours() - 1);
      
      // Reference to the correct database path
      const dbRef = scanType === "packing" ? "packing_scans" : "dispatch_scans";
      
      // Query Firebase for scans in the last hour from this station
      db.ref(dbRef).orderByChild("Station ID").equalTo(stationId).once("value")
        .then((snapshot) => {
          let count = 0;
          
          snapshot.forEach((childSnapshot) => {
            const scan = childSnapshot.val();
            
            // Parse the date and time from the scan
            const scanDate = scan.DATE;
            const scanTime = scan.TIME;
            const scanDateTime = new Date(`${scanDate} ${scanTime}`);
            
            // Count only scans from the last hour
            if (scanDateTime >= oneHourAgo) {
              count++;
            }
          });
          
          // Update the count display
          countElement.textContent = count;
        })
        .catch((error) => {
          console.error("Error fetching scan counts:", error);
          countElement.textContent = "Error";
        });
    }

    // Set up periodic refresh of station counts (every 45 seconds)
    function setupCountRefresh() {
      // Initial update
      updateStationCount("packing");
      updateStationCount("dispatch");
      
      // Refresh every 45 seconds
      setInterval(() => {
        const activeTab = document.querySelector(".tab.active").id;
        if (activeTab === "packingTab") {
          updateStationCount("packing");
        } else if (activeTab === "dispatchTab") {
          updateStationCount("dispatch");
        }
      }, 45000); // 45 seconds
    }

    // Initialize count refresh
    setupCountRefresh();

    // ===== PACKING SCAN FUNCTIONALITY =====
    
    // Listen for input in the packing shipping ID field
    document.getElementById("packingShippingID").addEventListener("input", function() {
      const scanId = this.value.trim().toUpperCase();
      this.value = scanId; // Convert to uppercase as they type
      
      // Validate the scan ID format
      if (isValidPackingScanId(scanId)) {
        this.classList.add("valid");
        this.classList.remove("invalid");
        
        // Check if all required fields are filled
        const stationID = document.getElementById("packingStationID").value;
        const nexSID = document.getElementById("packingNexSID").value.trim();
        
        if (stationID && nexSID) {
          // Auto-submit the form if all fields are valid
          processPacking(scanId, stationID, nexSID);
        }
      } else {
        // Mark as invalid if format is wrong
        if (scanId.length > 0) {
          this.classList.add("invalid");
          this.classList.remove("valid");
        } else {
          // Clear styling if empty
          this.classList.remove("valid");
          this.classList.remove("invalid");
        }
      }
    });

    // Process Packing Scan
    function processPacking(scanId, stationId, nexSId) {
      // First check if this scan ID has already been processed
      db.ref(`packing_scans/${scanId}`).once("value")
        .then((snapshot) => {
          if (snapshot.exists()) {
            // Scan already exists, check if at a different station
            const existingData = snapshot.val();
            if (existingData["Station ID"] !== stationId) {
              // Show duplicate warning modal
              showDuplicateModal(scanId, existingData["Station ID"]);
              document.getElementById("packingShippingID").value = "";
              return; // Stop processing
            }
          }
          
          // Continue with normal processing
          const now = new Date();
          const date = now.toISOString().split('T')[0];
          const time = now.toLocaleTimeString("en-GB");

          // Check if shipping metadata exists for this ID
          firebase.database().ref("shipping_metadata/" + scanId).once("value")
            .then(metaSnapshot => {
              const cityData = metaSnapshot.val();
              
              // Save the scan data
              db.ref(`packing_scans/${scanId}`).set({
                "Station ID": stationId,
                "NexS ID": nexSId,
                "DATE": date,
                "TIME": time,
              }).then(() => {
                // Show success toast
                showToast("Packing scan successful");
                
                // Show city modal if city data exists
                if (cityData && cityData.City) {
                  const city = cityData.City.toUpperCase();
                  showCityModal(city);
                }
                
                // Clear only the Scan ID field
                document.getElementById("packingShippingID").value = "";
                document.getElementById("packingShippingID").classList.remove("valid");
                
                // Update the scan count
                updateStationCount("packing");
              });
            })
            .catch(error => {
              console.error("Packing Scan Error:", error);
              showToast("Error processing scan", "error");
            });
        })
        .catch(error => {
          console.error("Error checking for duplicate:", error);
          showToast("Error checking for duplicates", "error");
        });
    }

    // Update station count when station is changed
    document.getElementById("packingStationID").addEventListener("change", function() {
      updateStationCount("packing");
    });

    // ===== DISPATCH SCAN FUNCTIONALITY =====
    
    // Listen for input in the dispatch shipping ID field
    document.getElementById("dispatchShippingID").addEventListener("input", function() {
      const scanId = this.value.trim().toUpperCase();
      this.value = scanId; // Convert to uppercase as they type
      
      // Check if the scan ID is in packing format (should be rejected)
      if (isPackingFormat(scanId)) {
        this.classList.add("invalid");
        this.classList.remove("valid");
        showToast("Invalid format for dispatch - cannot use packing format", "error");
        return;
      }
      
      // Basic validation - just ensure it's not empty
      if (scanId.length > 0) {
        this.classList.add("valid");
        this.classList.remove("invalid");
        
        // Check if all required fields are filled
        const stationID = document.getElementById("dispatchStationID").value;
        const nexSID = document.getElementById("dispatchNexSID").value.trim();
        
        if (stationID && nexSID) {
          // Auto-submit the form if all fields are valid
          processDispatch(scanId, stationID, nexSID);
        }
      } else {
        // Clear styling if empty
        this.classList.remove("valid");
        this.classList.remove("invalid");
      }
    });

    // Process Dispatch Scan
    function processDispatch(scanId, stationId, nexSId) {
      // First check if this scan ID has already been processed
      db.ref(`dispatch_scans/${scanId}`).once("value")
        .then((snapshot) => {
          if (snapshot.exists()) {
            // Scan already exists, check if at a different station
            const existingData = snapshot.val();
            if (existingData["Station ID"] !== stationId) {
              // Show duplicate warning
              showDuplicateModal(scanId, existingData["Station ID"]);
              document.getElementById("dispatchShippingID").value = "";
              return; // Stop processing
            }
          }
          
          // Continue with normal processing
          const now = new Date();
          const date = now.toISOString().split('T')[0];
          const time = now.toLocaleTimeString("en-GB");

          // Check if shipping metadata exists for this ID
          firebase.database().ref("shipping_metadata/" + scanId).once("value")
            .then(metaSnapshot => {
              const cityData = metaSnapshot.val();
              
              // Save the scan data
              db.ref(`dispatch_scans/${scanId}`).set({
                "Station ID": stationId,
                "NexS ID": nexSId,
                "DATE": date,
                "TIME": time,
              }).then(() => {
                // Show success toast
                showToast("Dispatch scan successful");
                
                // Show city modal if city data exists
                if (cityData && cityData.City) {
                  const city = cityData.City.toUpperCase();
                  showCityModal(city);
                }
                
                // Clear only the Scan ID field
                document.getElementById("dispatchShippingID").value = "";
                document.getElementById("dispatchShippingID").classList.remove("valid");
                
                // Update the scan count
                updateStationCount("dispatch");
              });
            })
            .catch(error => {
              console.error("Dispatch Scan Error:", error);
              showToast("Error processing scan", "error");
            });
        })
        .catch(error => {
          console.error("Error checking for duplicate:", error);
          showToast("Error checking for duplicates", "error");
        });
    }

    // Update station count when station is changed
    document.getElementById("dispatchStationID").addEventListener("change", function() {
      updateStationCount("dispatch");
    });

    // ===== EXCEL UPLOAD FUNCTIONALITY =====
    document.getElementById("excelForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const fileInput = document.getElementById("excelFile");
      const file = fileInput.files[0];
      
      if (!file) {
        showToast("Please select an Excel file first!", "error");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        
        let count = 0;
        rows.forEach((row) => {
          if (row.ShippingID && row.City) {
            db.ref("shipping_metadata/" + row.ShippingID).set({ City: row.City });
            count++;
          }
        });

        showToast(`Excel uploaded successfully! ${count} shipping records imported.`);
        fileInput.value = "";
      };
      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
